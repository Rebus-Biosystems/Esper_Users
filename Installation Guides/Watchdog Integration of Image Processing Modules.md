Watchdog Integration of Image Processing Modules: Interface Documentation

Purpose
Watchdog Integration of Image Processing Modules: Interface Documentation describes the eventual interface between Esper Control and Esper Process. But for Q3 2021, we need a pared down version that can be implemented.
•	Run folder will not have ROI subfolders
•	Run folder will have FOVlist.txt file, as it is required for simulation purposes.
•	Will not use a “methods” file to set image processing parameters
o	Parameters are hardcoded into find_spots.py
•	Will use Watchdog’s logging facility to log all external executable calls, including Python scripts.
Notes about this document
-	Starfish class refers to these data structures: https://spacetx-starfish.readthedocs.io/en/latest/api/data_structures/index.html
Output folder structure
Run folder
    (Matt Cai 06262021: Up to Sean/Hojin whether to keep these)
    -	GeneTable.csv
    -	RunParams.ini (autogenerated by Esper SW after ROI selection)
        o	API version (API=1.6) (interim=1.55?)
        o	ROI count (ROI_count=1, for interim)
        o	Laser channel count (Lasers=3)
        o	Other image processing parameters that were used (TBD)
    -   Acquisition logs folder
        o	Timestamped logs
        o	Watchdog log includes parameters and results for each script and executable call (ReconD, ReconL, etc.)
    -	Run config folder (proprietary config info)
        o	532.cfg
        o	595.cfg
        o	647.cfg
    -	AcqData
    -	SaoRecon
        o	DAPI_r_<fov-name>…
        o	HF_r.c_<fov-name>...
        o	MOD_r.c_<fov-name>...
        o	S_r.c_<fov-name>…
    -	Results (image processing output)
        o	FOVs folder
            	Peaks
            	SpotTables
            	Registration
            	Segmentation
        o	AssignedSpotTable_ROI.netcdf
        o	SpotTable_ROI.netcdf
        o	SegResults_ROI.netcdf
        o	CellxFeature.netcdf

Image Processing Modules
Input/Output Files with Watchdog Triggers

    o	MakeCodebook
        	Purpose: Generate codebook.json from GeneTable.csv
        	Trigger condition: FOVlist.txt file detection or rename event.
        	Time Estimate: < 5 seconds
        	Inputs
            •	GeneTable.csv
        	Outputs
            •	codebook.json
        	Watchdog command
“C:\Users\Optical User\.conda\envs\imageprocess16\python.exe” make_codebook.py genetable_path

    o	FindSpots
        	Purpose: Generate the spot table for a single FOV
        	Trigger condition: exit code of 0 for corresponding ReconL call.
        	Time Estimate: 10 seconds
        	Inputs
            •	S_r#.c#_<fov-name>_<gene>.*
    o	starfish class: ImageStack
            •	HF_r#.c#_<fov-name>_<gene>.*
    o	starfish class: ImageStack
            •	MOD_r#.c#_<fov-name>_<gene>.*
    o	starfish class: ImageStack
            •	codebook.json
    o	JSON that reformats information from GeneTable.csv
        	Outputs
            •	SpotTable_r#.c#_<fov-name>.netcdf
    o	starfish class: DecodedIntensityTable 
        	Watchdog command
“C:\Users\Optical User\.conda\envs\imageprocess16\python.exe” find_spots.py s_fullpath hf_fullpath mod_fullpath codebook_fullpath


    o	SegmentNuclei 
        	Purpose: Generate nuclei segmentation data for a single FOV.
        	Trigger condition: exit code of 0 for corresponding ReconD call.
        	Time Estimate:
        	Inputs
            •	DAPI_r1_<fov-name>.*
        	Outputs
            •	SegResults_<fov-name>.tar.gz
                o	starfish class: BinaryMaskCollection
        	Watchdog command
“C:\Users\Optical User\.conda\envs\imageprocess16\python.exe” segment_nuclei.py dapi_fullpath

    o	ConcatPerCycleSpotTables 
        	Purpose: Concatenate all spot tables for an FOV and cycle, across channels.
        	Trigger condition: FindSpots completed for all (typically 3) laser channels
        	Time Estimate: 0.5 seconds
        	Inputs
            •	SpotTable_r#.c1_<fov-name>.netcdf
            •	SpotTable_r#.c2_<fov-name>.netcdf
            •	SpotTable_r#.c3_<fov-name>.netcdf
        	Outputs
            •	SpotTable_r#_<fov-name>.netcdf
                o	starfish class: DecodedIntensityTable
        	Watchdog command
“C:\Users\Optical User\.conda\envs\imageprocess16\python.exe” concat_spottable.py ch1_table_path ch2_table_path ch3_table_path

    o	Register ALL FOVs: 
        	Purpose: Register position offsets for all FOVs
        	Trigger condition: DAPI SaoRecon complete for all cycles
        	Time Estimate: 2s per FOV (300 FOV run will take 10 min)
        	Inputs
            •	Directory containing all DAPI_r#_<fov-name>.*
        	Outputs
            •	RegistrationOffsets_<fov-name>.json
                o	starfish class: TransformsList
        	Watchdog command
“C:\Users\Optical User\.conda\envs\imageprocess16\python.exe” register_fovs.py saorecon_dir

    o	StitchSpotTables  
        	Purpose: Merge spot tables from each cycle together
        	TriggerCondition: FOV registration and ConcatPerCycleSpotTables complete for all FOVs and cycles
        	Time Estimate: Depends on #FOVs but already >400% faster than v1.5
        	Inputs
            •	SpotTable_r#_<fov-name>.netcdf
            •	RegistrationOffsets_<fov-name>.json
            •	codebook.json
        	Outputs
            •	SpotTable_ROI.netcdf
        	Watchdog command
“C:\Users\Optical User\.conda\envs\imageprocess16\python.exe” stitch_spottable.py table_dir offset_dir codebook_path

    o	StitchSegResults
        	Purpose: Merge the spot tables from all cycles together
        	Trigger condition: Completion of StitchSpotTables
        	Time Estimate: ~1 min
        	Inputs
            •	SegResults_<fov-name>.tar.gz
    o	starfish class: BinaryMaskCollection
        	Outputs
            •	SegResults_ROI.tar.gz
    	Watchdog command
“C:\Users\Optical User\.conda\envs\imageprocess16\python.exe” stitch_segresults.py segresults_dir

    o	PerCellAnalysis
        (Matt Cai 06082021: Currently this does a basic algorithm similar to PerCellAnalysis v1.4 with radius=1. This module needs to be sped up significantly AND made more sophisticated.)
        	Purpose: Generate Cell by Feature reports
        	Trigger condition: StitchSegResults complete
        	Time Estimate: 12+ hours
        	Inputs
            •	SpotTable_ROI.netcdf
            •	SegResults_ROI.tar.gz
        	Outputs
        •	AssignedSpotTable_ROI.netcdf
            o	starfish class: DecodedIntensityTable
        •	CellxFeature.h5ad
            o	class: AnnData
        •	CellxFeature.netcdf
            o	starfish class: ExpressionMatrix
        	Watchdog command
“C:\Users\Optical User\.conda\envs\imageprocess16\python.exe” percellanalysis.py stitched_segresults stitched_spottable


